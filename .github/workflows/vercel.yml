name: Vercel
on: [pull_request, workflow_dispatch]
permissions: { contents: read }
concurrency: { group: vercel-${{ github.ref }}, cancel-in-progress: true }

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Secrets gate
        id: gate
        if: ${{ secrets.VERCEL_TOKEN && secrets.VERCEL_ORG_ID && secrets.VERCEL_PROJECT_ID && secrets.VERCEL_SCOPE }}
        run: echo "All Vercel secrets present."

      - name: No-op if secrets missing
        if: ${{ ! (secrets.VERCEL_TOKEN && secrets.VERCEL_ORG_ID && secrets.VERCEL_PROJECT_ID && secrets.VERCEL_SCOPE) }}
        run: echo "Vercel secrets incomplete; passing job as no-op."

      - uses: actions/checkout@v4
        if: steps.gate.conclusion == success

      - name: Verify Vercel auth
        if: steps.gate.conclusion == success
        run: |
          npm i -g vercel@latest >/dev/null 2>&1
          vercel --version
          vercel --token="${{ secrets.VERCEL_TOKEN }}" --scope="${{ secrets.VERCEL_SCOPE }}" whoami

      - uses: pnpm/action-setup@v4
        if: steps.gate.conclusion == success
        with: { version: 9 }

      - uses: actions/setup-node@v4
        if: steps.gate.conclusion == success
        with: { node-version: 20, cache: pnpm }

      - run: pnpm install --frozen-lockfile
        if: steps.gate.conclusion == success

      - working-directory: apps/web
        if: steps.gate.conclusion == success
        run: pnpm build:ci || pnpm next build

      - uses: amondnet/vercel-action@v25
        if: steps.gate.conclusion == success
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          working-directory: ./apps/web
          scope: ${{ secrets.VERCEL_SCOPE }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
