#!/usr/bin/env node
/*
 Simple docs generator for Nexa ERP.
 - Rebuilds apps/web/docs/TOC.md
 - Rebuilds apps/web/docs/INDEX.md sections with links to all files
 Notes: British English; no secrets; paths relative to docs root.
*/
const fs = require('fs');
const path = require('path');

const DOCS_ROOT = path.resolve(__dirname, '../../apps/web/docs');

function walkMarkdownFiles(rootDir) {
  /** @type {string[]} */
  const files = [];
  /** @param {string} dir */
  function walk(dir) {
    for (const entry of fs.readdirSync(dir, { withFileTypes: true })) {
      if (entry.name.startsWith('.')) continue;
      const full = path.join(dir, entry.name);
      if (entry.isDirectory()) {
        walk(full);
      } else if (entry.isFile() && entry.name.toLowerCase().endsWith('.md')) {
        files.push(full);
      }
    }
  }
  walk(rootDir);
  files.sort();
  return files;
}

function toRel(p) {
  return path.relative(DOCS_ROOT, p).replace(/\\/g, '/');
}

function writeTOC(files) {
  const tocPath = path.join(DOCS_ROOT, 'TOC.md');
  const lines = [];
  lines.push('# Nexa ERP — Table of Contents');
  lines.push('');
  lines.push('_This TOC is generated by `pnpm -w docs:gen`_');
  lines.push('');
  for (const f of files) {
    const rel = toRel(f);
    lines.push(`- ${rel}`);
  }
  fs.writeFileSync(tocPath, lines.join('\n') + '\n', 'utf8');
}

function link(rel) {
  const name = rel.split('/').pop();
  return `- [${name}](./${rel})`;
}

function groupFiles(files) {
  const rels = files.map(toRel);
  const groups = {
    gettingStarted: [],
    modules: [],
    connectors: [],
    processes: [],
    compliance: [],
    legal: [],
    mobile: [],
    flows: [],
  };
  for (const rel of rels) {
    const parts = rel.split('/');
    if (parts.length === 1) {
      // top-level under docs
      if (!['INDEX.md', 'TOC.md'].includes(parts[0])) groups.gettingStarted.push(rel);
      continue;
    }
    const [folder, ...rest] = parts;
    if (folder === 'modules') {
      groups.modules.push(rel);
      const base = rest[rest.length - 1] || '';
      if (base.startsWith('connectors-') || ['open-banking.md', 'hmrc.md', 'crm-integrations.md', 'connectors.md'].includes(base)) {
        groups.connectors.push(rel);
      }
      continue;
    }
    if (folder === 'processes' || folder === 'ops') {
      groups.processes.push(rel);
      continue;
    }
    if (folder === 'compliance') {
      groups.compliance.push(rel);
      continue;
    }
    if (folder === 'legal') {
      groups.legal.push(rel);
      continue;
    }
    if (folder === 'mobile') {
      groups.mobile.push(rel);
      continue;
    }
    if (folder === 'flows' || folder === 'phase7') {
      groups.flows.push(rel);
      continue;
    }
  }
  return groups;
}

function writeIndex(groups) {
  const indexPath = path.join(DOCS_ROOT, 'INDEX.md');
  const today = new Date().toISOString().slice(0, 10);
  const lines = [];
  lines.push('# Nexa ERP — Documentation Index');
  lines.push('');
  lines.push(`Last updated: ${today}`);
  lines.push('');
  lines.push('## Getting started');
  lines.push(...(groups.gettingStarted.length ? groups.gettingStarted.map(link) : ['- (none)']));
  lines.push('');
  lines.push('## Modules');
  lines.push(...(groups.modules.length ? groups.modules.map(link) : ['- (none)']));
  lines.push('');
  lines.push('## Connectors');
  lines.push(...(groups.connectors.length ? groups.connectors.map(link) : ['- (none)']));
  lines.push('');
  lines.push('## Processes & Runbooks');
  lines.push(...(groups.processes.length ? groups.processes.map(link) : ['- (none)']));
  lines.push('');
  lines.push('## Compliance & Governance');
  lines.push(...(groups.compliance.length ? groups.compliance.map(link) : ['- (none)']));
  lines.push('');
  lines.push('## Legal');
  lines.push(...(groups.legal.length ? groups.legal.map(link) : ['- (none)']));
  lines.push('');
  lines.push('## Mobile (Expo / iOS / Android)');
  lines.push(...(groups.mobile.length ? groups.mobile.map(link) : ['- (none)']));
  lines.push('');
  lines.push('## End-to-End Business Flows');
  lines.push(...(groups.flows.length ? groups.flows.map(link) : ['- (none)']));
  lines.push('');
  fs.writeFileSync(indexPath, lines.join('\n') + '\n', 'utf8');
}

(function main() {
  if (!fs.existsSync(DOCS_ROOT)) {
    console.error('Docs root not found:', DOCS_ROOT);
    process.exit(1);
  }
  const files = walkMarkdownFiles(DOCS_ROOT);
  writeTOC(files);
  const groups = groupFiles(files);
  writeIndex(groups);
  // Write inventory file
  const REPORTS_DIR = path.resolve(__dirname, '../../reports');
  try { fs.mkdirSync(REPORTS_DIR, { recursive: true }); } catch {}
  const ts = new Date().toISOString().replace(/[-:TZ.]/g, '').slice(0, 14);
  const invPath = path.join(REPORTS_DIR, `docs-inventory-${ts}.txt`);
  const inv = [];
  inv.push(`Nexa ERP — Docs Inventory (${new Date().toString()})`);
  inv.push('Root: apps/web/docs');
  inv.push('');
  for (const f of files) inv.push(toRel(f));
  fs.writeFileSync(invPath, inv.join('\n') + '\n', 'utf8');
  console.log('Docs index and TOC regenerated. Inventory:', invPath);
})();


