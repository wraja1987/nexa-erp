# Force HTTPS and www
RewriteEngine On
RewriteCond %{HTTPS} !=on [OR]
RewriteCond %{HTTP_HOST} !^www\. [NC]
RewriteRule ^(.*)$ https://www.nexaai.co.uk/$1 [R=301,L]

# Security headers
Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
Header set X-Content-Type-Options nosniff
Header set Referrer-Policy no-referrer-when-downgrade
Header set X-Frame-Options SAMEORIGIN

# CSP (Report-Only initially)
Header set Content-Security-Policy-Report-Only "default-src 'self'; img-src 'self' data: https:; script-src 'self'; style-src 'self' 'unsafe-inline'; font-src 'self' data:; connect-src 'self' https://app.nexaai.co.uk; frame-ancestors 'self'; report-uri https://reports.nexaai.co.uk/csp"

# Caching
<FilesMatch "\.(avif|webp|png|jpe?g|gif|svg|js|css|woff2?)$">
  Header set Cache-Control "public, max-age=31536000, immutable"
</FilesMatch>
<FilesMatch "\.(html)$">
  Header set Cache-Control "no-cache, no-store, must-revalidate"
</FilesMatch>

# Compression
AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css application/javascript application/json image/svg+xml

# Custom 404
ErrorDocument 404 /website/404.html

# Staging noindex (apply to any host not exactly www.nexaai.co.uk)
SetEnvIfNoCase Host "^(?!www\\.nexaai\\.co\\.uk$)" is_staging=1
Header set X-Robots-Tag "noindex, nofollow, noarchive" env=is_staging
